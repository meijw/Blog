<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--><!--[if gt IE 8]><!--><html class="no-js">
<!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> <title>Java反射机制 – ATERRO</title> <meta name="description" content="Though usually reliable,I may let one or two important things slip through my fingers for no apparent reason."> <meta name="keywords" content="Java"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="https://meijw.github.io/Blog//assets/img/logo1.png"> <meta name="twitter:title" content="Java反射机制"> <meta name="twitter:description" content="Java反射机制是一个非常强大的功能，在很多大型项目比如Spring, Mybatis中都可以看见反射的身影。"> <!-- Open Graph --> <meta property="og:locale" content="cn"> <meta property="og:type" content="article"> <meta property="og:title" content="Java反射机制"> <meta property="og:description" content="Java反射机制是一个非常强大的功能，在很多大型项目比如Spring, Mybatis中都可以看见反射的身影。"> <meta property="og:url" content="https://meijw.github.io/Blog//2015/04/01/Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/"> <meta property="og:site_name" content="ATERRO"> <meta property="og:image" content="https://meijw.github.io/Blog//assets/img/logo1.png"> <link rel="canonical" href="https://meijw.github.io/Blog//2015/04/01/Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/"> <link href="https://meijw.github.io/Blog//feed.xml" type="application/atom+xml" rel="alternate" title="ATERRO Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="https://meijw.github.io/Blog//assets/css/main.css"> <!-- JS --> <script src="https://meijw.github.io/Blog//assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="https://meijw.github.io/Blog//assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="https://meijw.github.io/Blog//assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="https://meijw.github.io/Blog//assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="https://meijw.github.io/Blog//assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="https://meijw.github.io/Blog//favicon.png"> <link rel="shortcut icon" href="https://meijw.github.io/Blog//favicon.ico"> <!-- Background Image --> <style type="text/css">body {background-image:url(https://meijw.github.io/Blog//assets/img/placeholder.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="https://meijw.github.io/Blog//">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="https://meijw.github.io/Blog//assets/img/logo1.png" alt="ATERRO photo" class="author-photo"> <h4>ATERRO</h4> <p>Though usually reliable,I may let one or two important things slip through my fingers for no apparent reason.</p> </li> <li><a href="https://meijw.github.io/Blog//about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="mailto:aterro@yeah.net" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-envelope-square"></i> Email</a> </li> <li> <a href="http://facebook.com/meijw.aterro" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-facebook-square"></i> Facebook</a> </li> <li> <a href="http://github.com/meijw" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> <li> <a href="http://www.weibo.com/aterro" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-weibo"></i> Weibo</a> </li> </ul>
<!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="https://meijw.github.io/Blog//posts/">All Posts</a></li> <li><a href="https://meijw.github.io/Blog//tags/">All Tags</a></li> </ul> </li> <li><a href="https://meijw.github.io/Blog//projects/">Projects</a></li> </ul>
<!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>Java反射机制</h1> <h4>01 Apr 2015</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~6 minutes </p>
<!-- /.entry-reading-time --> <a class="btn zoombtn" href="https://meijw.github.io/Blog//posts/"> <i class="fa fa-chevron-left"></i> </a> </div> <hr> <ul id="markdown-toc"> <li><a href="#%E5%BC%95%E8%A8%80" id="markdown-toc-引言">引言</a></li> <li>
<a href="#%E5%8F%8D%E5%B0%84%E5%9F%BA%E7%A1%80" id="markdown-toc-反射基础">反射基础</a> <ul> <li><a href="#%E9%80%9A%E8%BF%87getclass%E6%96%B9%E6%B3%95" id="markdown-toc-通过getclass方法">通过getClass方法</a></li> <li><a href="#%E9%80%9A%E8%BF%87forname%E6%96%B9%E6%B3%95" id="markdown-toc-通过forname方法">通过forName方法</a></li> <li><a href="#%E4%BD%BF%E7%94%A8class" id="markdown-toc-使用class">使用.class</a></li> </ul> </li> <li><a href="#%E8%8E%B7%E5%8F%96%E7%B1%BB%E5%9E%8B%E4%BF%A1%E6%81%AF" id="markdown-toc-获取类型信息">获取类型信息</a></li> <li><a href="#%E5%88%A9%E7%94%A8%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E5%AE%9E%E7%8E%B0%E9%9D%A2%E5%90%91%E5%88%87%E9%9D%A2%E7%BC%96%E7%A8%8B" id="markdown-toc-利用动态代理实现面向切面编程">利用动态代理实现面向切面编程</a></li> <li><a href="#%E4%B8%8E%E6%B3%A8%E8%A7%A3%E7%9B%B8%E7%BB%93%E5%90%88" id="markdown-toc-与注解相结合">与注解相结合</a></li> <li><a href="#%E8%A7%A3%E5%86%B3%E6%B3%9B%E5%9E%8B%E6%93%A6%E9%99%A4" id="markdown-toc-解决泛型擦除">解决泛型擦除</a></li> </ul> <hr> <h1 id="引言">引言</h1> <p>Java反射机制是一个非常强大的功能，在很多大型项目比如Spring, Mybatis中都可以看见反射的身影。通过反射机制我们可以在运行期间获取对象的类型信息，利用这一特性我们可以实现工厂模式和代理模式等设计模式，同时也可以解决Java泛型擦除等令人苦恼的问题。本文我们就从实际应用的角度出发，来应用一下Java的反射机制。</p> <h1 id="反射基础">反射基础</h1> <p>p.s: 本文需要读者对反射机制的API有一定程度的了解，如果之前没有接触过的话，建议先看一下官方文档的Quick Start。</p> <p>在应用反射机制之前，首先我们先来看一下如何获取一个对象对应的反射类Class，在Java中我们有三种方法可以获取一个对象的反射类。</p> <h2 id="通过getclass方法">通过getClass方法</h2> <p>在Java中，每一个Object都有一个getClass()方法，通过getClass方法我们可以获取到这个对象对应的反射类：</p> <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="s">"aterro"</span><span class="o">;</span>
<span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
</code></pre></div> <h2 id="通过forname方法">通过forName方法</h2> <p>我们也可以调用Class类的静态方法forName()：</p> <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"java.lang.String"</span><span class="o">);</span>
</code></pre></div> <h2 id="使用class">使用.class</h2> <p>或者我们也可以直接使用.class：</p> <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
</code></pre></div> <h1 id="获取类型信息">获取类型信息</h1> <p>在文章开头我们就提到反射的一大好处就是可以允许我们在运行期间获取对象的类型信息，下面我们通过一个例子来具体看一下。</p> <p>首先我们在typeinfo.interfacea包下面新建一个接口A：</p> <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">typeinfo</span><span class="o">.</span><span class="na">interfacea</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">A</span> <span class="o">{</span>
	<span class="kt">void</span> <span class="nf">f</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div> <p>接着我们在typeinfo.packageaccess包下面新建一个类C，类C实现了接口A，并且我们还另外创建了几个用于测试的方法，注意下面几个方法的权限都是不同的。</p> <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">typeinfo</span><span class="o">.</span><span class="na">packageaccess</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">typeinfo.interfacea.A</span><span class="o">;</span>
<span class="kd">class</span> <span class="nc">C</span> <span class="kd">implements</span> <span class="n">A</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">f</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"public C.f()"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">g</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"public C.g()"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">v</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"protected C.v()"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kt">void</span> <span class="nf">u</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"package C.u()"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">w</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"private C.w()"</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HiddenC</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="n">A</span> <span class="nf">makeA</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">C</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div> <p>在callHiddenMethod()方法中我们用到了几个新的API，其中getDeclaredMethod()根据方法名用于获取Class类指代对象自己声明的某个方法，然后我们通过调用invoke()方法就可以触发对象的相关方法：</p> <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">typeinfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">typeinfo.interfacea.A</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">typeinfo.packageaccess.HiddenC</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HiddenImplementation</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">A</span> <span class="n">a</span> <span class="o">=</span> <span class="n">HiddenC</span><span class="o">.</span><span class="na">makeA</span><span class="o">();</span>
		<span class="n">a</span><span class="o">.</span><span class="na">f</span><span class="o">();</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
		<span class="c1">// Oops! Reflection still allows us to call g():</span>
		<span class="n">callHiddenMethod</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="s">"g"</span><span class="o">);</span>
		<span class="c1">// And even methods that are less accessible!</span>
		<span class="n">callHiddenMethod</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="s">"u"</span><span class="o">);</span>
		<span class="n">callHiddenMethod</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="s">"v"</span><span class="o">);</span>
		<span class="n">callHiddenMethod</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="s">"w"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">static</span> <span class="kt">void</span> <span class="nf">callHiddenMethod</span><span class="o">(</span><span class="n">Object</span> <span class="n">a</span><span class="o">,</span> <span class="n">String</span> <span class="n">methodName</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">Method</span> <span class="n">g</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="n">methodName</span><span class="o">);</span>
		<span class="n">g</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
		<span class="n">g</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div> <p>从输出结果我们可以看出来，不管是public，default，protect还是private方法，通过反射类我们都可以自由调用。当然这里我们只是为了显示反射的强大威力，在实际开发中这种技巧还是不提倡。</p> <div class="highlighter-rouge"><pre class="highlight"><code>public C.f()
typeinfo.packageaccess.C
public C.g()
package C.u()
protected C.v()
private C.w()
</code></pre></div> <p>上面我们只是测试了Method对象，感兴趣的读者在熟悉了反射的API之后，不妨测试一下Filed，这里我们就不重复了。</p> <h1 id="利用动态代理实现面向切面编程">利用动态代理实现面向切面编程</h1> <p>AOP是Spring提供的一个强大特性之一，AOP的意思是面向切面编程，就是说要分离和业务不相关的代码，当我们需要新增相关的事务的时候，我们不想要对业务本身做修改。面向切面编程和面向对象变成相比到底有什么好处呢，我们通过一个例子来看一下，对于新手来说，常常会写出下面这样的代码：</p> <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Example1</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">()</span> <span class="o">{</span>
	<span class="c1">// 记录日志</span>
	<span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="o">.</span><span class="na">getLog</span><span class="o">(...);</span>
	<span class="c1">// 进行性能统计</span>
	<span class="n">PerformanceUtil</span><span class="o">.</span><span class="na">startTimer</span><span class="o">(...);</span>
	<span class="c1">// 权限检查</span>
	<span class="k">if</span> <span class="o">(!</span><span class="n">user</span><span class="o">.</span><span class="na">hasPrevilege</span><span class="o">())</span> <span class="o">{</span>
	<span class="c1">// 抛出异常</span>
	<span class="o">}</span>
	<span class="c1">// 执行真正的业务</span>
	<span class="n">executeTransaction</span><span class="o">();</span>
	<span class="n">PerformanceUtil</span><span class="o">.</span><span class="na">endTimer</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div> <p>虽然我们上面真正要执行的业务只有executeTransaction()，但是日志，性能，权限相关的代码差不多要将真正的业务代码掩盖了。而且以后如果我们还有一个Example2，它同样需要实现相同的日志，性能，权限代码。这样当以后我们需要新增相关的逻辑检查的时候，我们需要所有Example进行重构，这显然不符合面向对象的一个基本原则-封装变化。</p> <p>上面这个场景利用模板方法和装饰器模式都可以解决，在Spring中是通过动态代理来实现的，下面我们通过一个例子来模拟一下Spring中的AOP实现。</p> <p>我们要实现的业务时，统计程序统计员工工资所执行的时间以及检查用户的权限。首先先来实现的Salary类，它里面包含一些实现统计员工工资的业务逻辑：</p> <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SalaryInterface</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSalary</span><span class="o">();</span>

	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Salary</span> <span class="kd">implements</span> <span class="n">SalaryInterface</span> <span class="o">{</span>

		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSalary</span><span class="o">()</span> <span class="o">{</span>
		<span class="o">...</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div> <p>通过InvocationHandler我们来实现动态代理，以后当我们调用obj的相关方法之前，都会通过invoke方法进行代理，而不会直接调用obj方法。</p> <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleProxy</span> <span class="kd">implements</span> <span class="n">InvocationHandler</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="n">Object</span> <span class="n">obj</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Object</span> <span class="n">advice</span><span class="o">;</span>

	<span class="c1">// 绑定代理对象</span>
	<span class="kd">public</span> <span class="n">Object</span> <span class="nf">bind</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">,</span> <span class="n">Advice</span> <span class="n">advice</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">advice</span> <span class="o">=</span> <span class="n">advice</span><span class="o">;</span>
		<span class="k">return</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">obj</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">(),</span><span class="n">obj</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getInterfaces</span><span class="o">(),</span> <span class="k">this</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="c1">// 实现代理</span>
	<span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
		<span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">advice</span><span class="o">.</span><span class="na">before</span><span class="o">();</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
			<span class="n">advice</span><span class="o">.</span><span class="na">after</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
		<span class="o">}</span>
			<span class="k">return</span> <span class="n">result</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div> <p>模拟Spring中的Advice接口：</p> <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Advice</span> <span class="o">{</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">before</span><span class="o">();</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">after</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div> <p>实现TimeAdvice用于统计程序的执行时间：</p> <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TimeAdvice</span> <span class="kd">implements</span> <span class="n">Advice</span> <span class="o">{</span>
	<span class="kt">long</span> <span class="n">startTime</span><span class="o">;</span>
	<span class="kt">long</span> <span class="n">endTime</span><span class="o">;</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">before</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span> <span class="c1">// 获取开始时间</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">after</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">endTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span> <span class="c1">// 获取结束时间</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div> <p>客户端调用代码如下：</p> <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">SimpleProxy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleProxy</span><span class="o">();</span>
		<span class="n">SalaryInterface</span> <span class="n">salaryInterface</span> <span class="o">=</span> <span class="o">(</span><span class="n">SalaryInterface</span><span class="o">)</span> <span class="n">simpleProxy</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="n">Salary</span><span class="o">(),</span> <span class="k">new</span> <span class="n">TimeAdvice</span><span class="o">());</span>
		<span class="n">salaryInterface</span><span class="o">.</span><span class="na">doSalary</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div> <p>如果我们现在需要新增权限控制，我们来实现ControlAdvie类：</p> <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ControlAdvice</span> <span class="kd">implements</span> <span class="n">Advice</span> <span class="o">{</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">before</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(...)</span> <span class="o">{</span>
		<span class="o">...</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
		<span class="o">...</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">after</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">...</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div> <p>而我们客户端的代码只需要改成simpleProxy.bind(new Salary(), new ControlAdvie)就行了，而SimpleProxy本身不需要做任何的修改。</p> <h1 id="与注解相结合">与注解相结合</h1> <p>在单元测试框架比如Junit中反射机制也得到了广泛的应用，即通过注解的方式。下面我们简单地来了解一下如何通过反射机制来获取相关方法的注解信息，比如说我们有下面这样一个业务场景，当用户在修改自己密码的时候，为了保证密码的安全性，我们要求用户的新密码要满足一些条件，比如说至少要包含一个非数字字符，不能与以前的密码相同之类的条件等。</p> <div class="highlighter-rouge"><pre class="highlight"><code>import java.lang.annotation.*
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface UserCase {
	public int id();
	public String description() default "no description";
}
</code></pre></div> <p>下面是我们检测密码的工具类的实现：</p> <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordUtils</span> <span class="o">{</span>
	<span class="nd">@UserCase</span><span class="o">(</span><span class="n">id</span><span class="o">=</span><span class="mi">47</span><span class="o">,</span> <span class="n">description</span><span class="o">=</span><span class="s">"Password must contain at least one numeric"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">validatePassword</span><span class="o">(</span><span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="o">(</span><span class="n">password</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="s">"\\w*\\d\\w*"</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="nd">@UserCase</span><span class="o">(</span><span class="n">id</span><span class="o">=</span><span class="mi">48</span><span class="o">)</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">encryptPassword</span><span class="o">(</span><span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">StringBuilder</span><span class="o">(</span><span class="n">password</span><span class="o">).</span><span class="na">reverse</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@UserCase</span><span class="o">(</span><span class="n">id</span><span class="o">=</span><span class="mi">49</span><span class="o">,</span> <span class="n">description</span><span class="o">=</span><span class="s">"New passwords can't equal previously used ones"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">checkForNewPassword</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">prevPasswords</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="o">!</span><span class="n">prevPasswords</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">password</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div> <p>利用反射我们可以写出更加清晰的测试代码，其中getDeclaredMethods()方法可以获取相关对象自己声明的相关方法，而getAnnotation()则可以获取Method对象的指定注解。</p> <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UseCaseTracker</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">trackUseCases</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">useCases</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">cl</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">Method</span> <span class="n">m</span> <span class="o">:</span> <span class="n">cl</span><span class="o">.</span><span class="na">getDeclaredMethods</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">UseCase</span> <span class="n">uc</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="n">UseCase</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">uc</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Found Use Case: "</span> <span class="o">+</span> <span class="n">uc</span><span class="o">.</span><span class="na">id</span><span class="o">()</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">uc</span><span class="o">.</span><span class="na">description</span><span class="o">());</span>
				<span class="n">useCases</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="k">new</span> <span class="n">Integer</span><span class="o">(</span><span class="n">uc</span><span class="o">.</span><span class="na">id</span><span class="o">()));</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">:</span> <span class="n">useCases</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Warning: Missing use case-"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">useCases</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;();</span>
		<span class="n">Collections</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">useCases</span><span class="o">,</span> <span class="mi">47</span><span class="o">,</span> <span class="mi">48</span><span class="o">,</span> <span class="mi">49</span><span class="o">,</span> <span class="mi">50</span><span class="o">);</span>
		<span class="n">trackUseCases</span><span class="o">(</span><span class="n">userCases</span><span class="o">,</span> <span class="n">PasswordUtils</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div> <h1 id="解决泛型擦除">解决泛型擦除</h1> <p>现在有下面这样一个业务场景，我们有一个泛型集合类List&lt;Class&lt;? extends Pet»，我们需要统计出这个集合类中每种具体的Pet有多少个。由于Java的泛型擦除，注意类似List&lt;? extends Pet&gt;的做法肯定是不行的，因为编译器做了静态类型检查之后，到了运行期间JVM会将集合中的对象都视为Pet，但是并不会知道Pet代表的究竟是Cat还是Dog，所以到了运行期间对象的类型信息其实全部丢失了。p.s: 关于泛型擦除，我在上一篇文章里面有详细解释，感兴趣的朋友可以看一看。 为了实现我们上面的例子，我们先来定义几个类：</p> <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Pet</span> <span class="kd">extends</span> <span class="n">Individual</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="nf">Pet</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">Pet</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Cat</span> <span class="kd">extends</span> <span class="n">Pet</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="nf">Cat</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">Cat</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Dog</span> <span class="kd">extends</span> <span class="n">Pet</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="nf">Dog</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">Dog</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EgyptianMau</span> <span class="kd">extends</span> <span class="n">Cat</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="nf">EgyptianMau</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">EgyptianMau</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Mutt</span> <span class="kd">extends</span> <span class="n">Dog</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="nf">Mutt</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">Mutt</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div> <p>上面的Pet类继承自Individual，Individual类的的实现稍微复杂一点，我们实现了Comparable接口，重新自定义了类的比较规则，如果不是很明白的话，也没有关系，我们已经将它抽象出来了，所以不理解实现原理也没有关系。</p> <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Individual</span> <span class="kd">implements</span> <span class="n">Comparable</span><span class="o">&lt;</span><span class="n">Individual</span><span class="o">&gt;</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">long</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">id</span> <span class="o">=</span> <span class="n">counter</span><span class="o">++;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span> <span class="c1">// name is optional</span>

	<span class="kd">public</span> <span class="nf">Individual</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">Individual</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">()</span> <span class="o">+</span> <span class="o">(</span><span class="n">name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s">""</span> <span class="o">:</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">name</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">long</span> <span class="nf">id</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">id</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">o</span> <span class="k">instanceof</span> <span class="n">Individual</span> <span class="o">&amp;&amp;</span> <span class="n">id</span> <span class="o">==</span> <span class="o">((</span><span class="n">Individual</span><span class="o">)</span> <span class="n">o</span><span class="o">).</span><span class="na">id</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">17</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">name</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="mi">37</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="n">name</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mi">37</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">id</span><span class="o">;</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">compareTo</span><span class="o">(</span><span class="n">Individual</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// Compare by class name first:</span>
		<span class="n">String</span> <span class="n">first</span> <span class="o">=</span> <span class="n">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">();</span>
		<span class="n">String</span> <span class="n">argFirst</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">();</span>
		<span class="kt">int</span> <span class="n">firstCompare</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">argFirst</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">firstCompare</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="n">firstCompare</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">name</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">arg</span><span class="o">.</span><span class="na">name</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="kt">int</span> <span class="n">secendCompare</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">arg</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">secendCompare</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">secendCompare</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="o">(</span><span class="n">arg</span><span class="o">.</span><span class="na">id</span> <span class="o">&lt;</span> <span class="n">id</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="o">(</span><span class="n">arg</span><span class="o">.</span><span class="na">id</span> <span class="o">==</span> <span class="n">id</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="o">));</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div> <p>下面创建了一个抽象类PetCreator，以后我们通过调用arrayList()方法便可以直接获取相关Pet类的集合。这里使用到了我们上面没有提及的newInstance()方法，它会返回Class类所真正指代的类的实例，这是什么意思呢？比如说声明new Dog().getClass().newInstance()和直接new Dog()是等价的。</p> <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">PetCreator</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="n">Random</span> <span class="n">rand</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">(</span><span class="mi">47</span><span class="o">);</span>

	<span class="c1">// The List of the different getTypes of Pet to create:</span>
	<span class="kd">public</span> <span class="kd">abstract</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Pet</span><span class="o">&gt;&gt;</span> <span class="nf">getTypes</span><span class="o">();</span>

	<span class="kd">public</span> <span class="n">Pet</span> <span class="nf">randomPet</span><span class="o">()</span> <span class="o">{</span>
		<span class="c1">// Create one random Pet</span>
		<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">getTypes</span><span class="o">().</span><span class="na">size</span><span class="o">());</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="k">return</span> <span class="nf">getTypes</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">n</span><span class="o">).</span><span class="na">newInstance</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InstantiationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="n">Pet</span><span class="o">[]</span> <span class="nf">createArray</span><span class="o">(</span><span class="kt">int</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Pet</span><span class="o">[]</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Pet</span><span class="o">[</span><span class="n">size</span><span class="o">];</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">result</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">randomPet</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Pet</span><span class="o">&gt;</span> <span class="nf">arrayList</span><span class="o">(</span><span class="kt">int</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Pet</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Pet</span><span class="o">&gt;();</span>
		<span class="n">Collections</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">createArray</span><span class="o">(</span><span class="n">size</span><span class="o">));</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div> <p>接下来我们来实现上面这一个抽象类，解释一下下面的代码，在下面的代码中，我们声明了两个集合类，allTypes和types，其中allTypes中包含了我们呢上面所声明的所有类，但是我们具体的类型实际上只有两种即Mutt和EgypianMau，所以我们真正需要new出来的宠物只是types中所包含的类型，以后我们通过调用getTypes()便可以得到types中所包含的所有类型。</p> <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LiteralPetCreator</span> <span class="kd">extends</span> <span class="n">PetCreator</span> <span class="o">{</span>
	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Pet</span><span class="o">&gt;&gt;</span> <span class="n">allTypes</span> <span class="o">=</span> <span class="n">Collections</span>
			<span class="o">.</span><span class="na">unmodifiableList</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">Pet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Dog</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Cat</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Mutt</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">EgyptianMau</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Pet</span><span class="o">&gt;&gt;</span> <span class="n">types</span> <span class="o">=</span> <span class="n">allTypes</span><span class="o">.</span><span class="na">subList</span><span class="o">(</span><span class="n">allTypes</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="n">Mutt</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
			<span class="n">allTypes</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>

	<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Pet</span><span class="o">&gt;&gt;</span> <span class="nf">getTypes</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">types</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div> <p>总体的逻辑已经完成了，最后我们实现用来统计集合中相关Pet类个数的TypeCounter类。解释一下isAssignalbeFrom()方法，它可以判断一个反射类是某个反射类的子类或者间接子类。而getSuperclass()顾名思义就是得到某个反射类的父类了。</p> <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TypeCounter</span> <span class="kd">extends</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">baseType</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">TypeCounter</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">baseType</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">baseType</span> <span class="o">=</span> <span class="n">baseType</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">count</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">type</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(!</span><span class="n">baseType</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">type</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">obj</span> <span class="o">+</span> <span class="s">" incorrect type "</span> <span class="o">+</span> <span class="n">type</span> <span class="o">+</span> <span class="s">", should be type or subtype of "</span> <span class="o">+</span> <span class="n">baseType</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="n">countClass</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">countClass</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Integer</span> <span class="n">quantity</span> <span class="o">=</span> <span class="n">get</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
		<span class="n">put</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">quantity</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">quantity</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
		<span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">superClass</span> <span class="o">=</span> <span class="n">type</span><span class="o">.</span><span class="na">getSuperclass</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">superClass</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">baseType</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">superClass</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">countClass</span><span class="o">(</span><span class="n">superClass</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">StringBuilder</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="s">"{"</span><span class="o">);</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">pair</span> <span class="o">:</span> <span class="n">entrySet</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="na">getKey</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">());</span>
			<span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"="</span><span class="o">);</span>
			<span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
			<span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">", "</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="n">result</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">2</span><span class="o">,</span> <span class="n">result</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
		<span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"} "</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div> <div class="entry-meta"> <br> <hr> <span class="entry-tags"><a href="https://meijw.github.io/Blog//tags/#Java" title="Pages tagged Java" class="tag"><span class="term">Java</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=https://meijw.github.io/Blog//2015/04/01/Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Share</span> </a> <a href="https://twitter.com/intent/tweet?text=https://meijw.github.io/Blog//2015/04/01/Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=https://meijw.github.io/Blog//2015/04/01/Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> </div> </div> </header> <!-- JS --> <script src="https://meijw.github.io/Blog//assets/js/jquery-1.12.0.min.js"></script> <script src="https://meijw.github.io/Blog//assets/js/jquery.dlmenu.min.js"></script> <script src="https://meijw.github.io/Blog//assets/js/jquery.goup.min.js"></script> <script src="https://meijw.github.io/Blog//assets/js/jquery.magnific-popup.min.js"></script> <script src="https://meijw.github.io/Blog//assets/js/jquery.fitvid.min.js"></script> <script src="https://meijw.github.io/Blog//assets/js/scripts.js"></script> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>

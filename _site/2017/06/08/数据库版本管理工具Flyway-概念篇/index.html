<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--><!--[if gt IE 8]><!--><html class="no-js">
<!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> <title>数据库版本管理工具Flyway——基础篇 – ATERRO</title> <meta name="description" content="Though usually reliable,I may let one or two important things slip through my fingers for no apparent reason."> <meta name="keywords" content="Microservices"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="https://meijw.github.io/Blog//assets/img/logo1.png"> <meta name="twitter:title" content="数据库版本管理工具Flyway——基础篇"> <meta name="twitter:description" content="最理想的数据库版本管理工具，它不但支持sql 脚本，还支持Java 代码直接操作数据库（在版本升级时做数据迁移相当有用），有Maven 插件，支持命令行（我们的平台数据库有部分由C语言项目管理），而且在Spring 框架的配合下，很容易就能实现应用启动时自动检查并升级数据库的功能"> <!-- Open Graph --> <meta property="og:locale" content="cn"> <meta property="og:type" content="article"> <meta property="og:title" content="数据库版本管理工具Flyway——基础篇"> <meta property="og:description" content="最理想的数据库版本管理工具，它不但支持sql 脚本，还支持Java 代码直接操作数据库（在版本升级时做数据迁移相当有用），有Maven 插件，支持命令行（我们的平台数据库有部分由C语言项目管理），而且在Spring 框架的配合下，很容易就能实现应用启动时自动检查并升级数据库的功能"> <meta property="og:url" content="https://meijw.github.io/Blog//2017/06/08/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7Flyway-%E6%A6%82%E5%BF%B5%E7%AF%87/"> <meta property="og:site_name" content="ATERRO"> <meta property="og:image" content="https://meijw.github.io/Blog//assets/img/logo1.png"> <link rel="canonical" href="https://meijw.github.io/Blog//2017/06/08/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7Flyway-%E6%A6%82%E5%BF%B5%E7%AF%87/"> <link href="https://meijw.github.io/Blog//feed.xml" type="application/atom+xml" rel="alternate" title="ATERRO Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="https://meijw.github.io/Blog//assets/css/main.css"> <!-- JS --> <script src="https://meijw.github.io/Blog//assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="https://meijw.github.io/Blog//assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="https://meijw.github.io/Blog//assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="https://meijw.github.io/Blog//assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="https://meijw.github.io/Blog//assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="https://meijw.github.io/Blog//favicon.png"> <link rel="shortcut icon" href="https://meijw.github.io/Blog//favicon.ico"> <!-- Background Image --> <style type="text/css">body {background-image:url(https://meijw.github.io/Blog//assets/img/placeholder.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="https://meijw.github.io/Blog//">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="https://meijw.github.io/Blog//assets/img/logo1.png" alt="ATERRO photo" class="author-photo"> <h4>ATERRO</h4> <p>Though usually reliable,I may let one or two important things slip through my fingers for no apparent reason.</p> </li> <li><a href="https://meijw.github.io/Blog//about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="mailto:aterro@yeah.net" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-envelope-square"></i> Email</a> </li> <li> <a href="http://facebook.com/meijw.aterro" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-facebook-square"></i> Facebook</a> </li> <li> <a href="http://github.com/meijw" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> <li> <a href="http://www.weibo.com/aterro" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-weibo"></i> Weibo</a> </li> </ul>
<!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="https://meijw.github.io/Blog//posts/">All Posts</a></li> <li><a href="https://meijw.github.io/Blog//tags/">All Tags</a></li> </ul> </li> <li><a href="https://meijw.github.io/Blog//projects/">Projects</a></li> </ul>
<!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>数据库版本管理工具Flyway——基础篇</h1> <h4>08 Jun 2017</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~2 minutes </p>
<!-- /.entry-reading-time --> <a class="btn zoombtn" href="https://meijw.github.io/Blog//posts/"> <i class="fa fa-chevron-left"></i> </a> </div> <hr> <ul id="markdown-toc"> <li><a href="#1--%E6%A6%82%E8%BF%B0" id="markdown-toc-1--概述">1. 概述</a></li> <li><a href="#2--%E4%BB%80%E4%B9%88%E6%98%AFflyway" id="markdown-toc-2--什么是flyway">2. 什么是Flyway</a></li> <li>
<a href="#3--%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8flyway" id="markdown-toc-3--为什么使用flyway">3. 为什么使用Flyway</a> <ul> <li><a href="#31-%E6%88%91%E4%BB%AC%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98" id="markdown-toc-31-我们遇到的问题">3.1. 我们遇到的问题</a></li> <li><a href="#32-flyway-%E7%9A%84%E7%89%B9%E6%80%A7" id="markdown-toc-32-flyway-的特性">3.2. Flyway 的特性</a></li> </ul> </li> <li>
<a href="#4--%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8flyway" id="markdown-toc-4--如何使用flyway">4. 如何使用Flyway</a> <ul> <li>
<a href="#41-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%84%9A%E6%9C%AC" id="markdown-toc-41-数据库脚本">4.1. 数据库脚本</a> <ul> <li><a href="#411-flyway%E7%9A%84sql%E8%84%9A%E6%9C%AC%E4%B8%8Ejava%E4%BB%A3%E7%A0%81%E9%83%BD%E9%81%B5%E5%BE%AA%E4%BB%A5%E4%B8%8B%E9%BB%98%E8%AE%A4%E8%A7%84%E7%BA%A6" id="markdown-toc-411-flyway的sql脚本与java代码都遵循以下默认规约">4.1.1. Flyway的sql脚本与java代码都遵循以下默认规约：</a></li> </ul> </li> <li>
<a href="#42-flyway-%E7%9A%84%E5%87%A0%E7%A7%8D%E8%BF%90%E8%A1%8C%E6%96%B9%E5%BC%8F" id="markdown-toc-42-flyway-的几种运行方式">4.2. Flyway 的几种运行方式</a> <ul> <li><a href="#421--%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%96%B9%E5%BC%8F" id="markdown-toc-421--命令行方式">4.2.1. 命令行方式</a></li> <li><a href="#422--maven-%E6%8F%92%E4%BB%B6" id="markdown-toc-422--maven-插件">4.2.2. Maven 插件</a></li> <li><a href="#423--%E5%9C%A8%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E6%97%B6%E8%87%AA%E5%8A%A8%E8%BF%90%E8%A1%8C%E7%BB%93%E5%90%88spring-" id="markdown-toc-423--在应用启动时自动运行结合spring-">4.2.3. 在应用启动时自动运行（结合Spring ）</a></li> </ul> </li> </ul> </li> <li><a href="#5--%E6%80%BB%E7%BB%93" id="markdown-toc-5--总结">5. 总结</a></li> </ul> <hr> <h1 id="1--概述">1. 概述</h1> <p>想到要管理数据库的版本，是在实际产品中遇到问题后想到的一种解决方案，当时各个环境的数据库乱作一团，没有任何一个人（开发、测试、维护人员）能够讲清楚当前环境下的数据库是哪个版本，与哪个版本的应用相匹配，如何升级到与新版本的应用相匹配。</p> <p>想到管理数据库版本时，先是心底形成了一个初步的解决方案，大致是通过数据库中的某张表来记录数据库表结构的历次更新与对应版本，在每次数据库表结构调整时除了提供库表更新sql ，还必须提供更新记录与对应版本的sql ，以帮助维护数据库版本信息，并在遇到问题时提供相关的排查依据。</p> <p>后来据此思路在网络上搜索了一把，结果搜到Liquibase （另一款开源数据库版本管理工具）。在学习了解Liquibase 的时候，经高手介绍又了解到了Flyway 这个项目的存在。经过一番了解，最后我们选择了Flyway ，主要原因是Flyway 支持sql 脚本，而Liquibase 只支持XML 方式的数据库表结构定义，虽然在新的版本中号称在XML 的数据库表结构定义方式中支持了sql 脚本。</p> <p>虽然Flyway的中文文档近乎为零，英文文档也凤毛麟角，但它却是我们最理想的数据库版本管理工具，它不但支持sql 脚本，还支持Java 代码直接操作数据库（在版本升级时做数据迁移相当有用），有Maven 插件，支持命令行（我们的平台数据库有部分由C语言项目管理），而且在Spring 框架的配合下，很容易就能实现应用启动时自动检查并升级数据库的功能。</p> <h1 id="2--什么是flyway">2. 什么是Flyway</h1> <p>Flyway 是独立于数据库的应用、管理并跟踪数据库变更的数据库版本管理工具。</p> <p>Flyway 的项目主页是 http://flywaydb.org/</p> <p>最近才迁移到这个主页，之前一直在googlecode 下管理 http://code.google.com/p/flyway/ ，在项目的主页上可以看到Flyway 与几款主流数据库版本管理工具的特性对比列表。</p> <h1 id="3--为什么使用flyway">3. 为什么使用Flyway</h1> <h2 id="31-我们遇到的问题">3.1. 我们遇到的问题</h2> <p>我们遇到的问题（以下内容来自Flyway 的一些英文文档，从中抽取出来的我们也遇到的一些主要问题）：</p> <ul> <li> <p>不同的开发人员在开发产品特性时，都有可能更新数据库（添加新表，新的约束等）。当开发人员完成工作并提交代码时，代码会被合并到主分支并在测试服务器上执行单元测试与集成测试。我们在哪个环节来执行数据库的更新操作呢？由QA 部门手工执行sql 脚本？或者我们开发一断程序自动执行数据库更新？以什么顺序来执行这些更新脚本？这些问题同样存在于生产环境。</p> </li> <li> <p>我们的产品部署在不同的客户服务器上，以及很多的测试、联调、实验局、销售环境上。不同的客户和测试环境上都部署着不同版本的产品。当他们需要升级他们的产品到新的版本时，我们不仅需要让他们的管理员可以升级产品到新的版本，同时需要保留他们的已有数据。在升级产品的步骤中，我们清楚地知道客户数据库的当前版本，以及需要在该数据库上执行哪些数据库更新脚本，来更新数据库表结构与数据库中已存在的数据。当升级完成时，数据库表结构及数据应当与升级后的产品版本保持一致。</p> </li> <li> <p>有的时候，我们需要通过代码（Java ）来维护一些已存在的数据，如通过代码来维护blob 类型的用户头像数据。</p> </li> <li> <p>当升级失败时（比如在升级过程中出现网络连接失败），我们应当支持对失败进行修复。</p> </li> </ul> <h2 id="32-flyway-的特性">3.2. Flyway 的特性</h2> <ul> <li> <p>自动升级（自动发现更新项）：Flyway 会将任意版本的数据库升级到最新版本。Flyway 可以脱离JVM 环境通过命令行执行，可以通过Ant 脚本执行，通过Maven 脚本执行（这样就可以在集成环境自动执行），并且可以在应用中执行（比如在应用启动时执行）。</p> </li> <li> <p>规约优于配置：Flyway 有一套默认的规约，所以不需要修改任何配置就可以正常使用。</p> </li> <li> <p>既支持SQL 脚本，又支持Java代码：可以使用SQL脚本执行数据库更新，也可以使用Java 代码来进行一些高级数据升级操作。</p> </li> <li> <p>高可靠性：在集群环境下进行数据库升级是安全可靠的。</p> </li> <li> <p>支持清除已存在的库表结构：Flyway 可以清除已存在的库表结构，可以从零开始搭建您的库表结构，并管理您的数据库版本升级工作。</p> </li> <li> <p>支持失败修复。新的2.0 版本提供了repair 功能，用于解决数据库更新操作失败问题。</p> </li> </ul> <p>结合我们遇到的问题，与Flyway 所提供的特性，我们认为Flyway 是比较适合于我们的一款数据库版本管理工具。</p> <h1 id="4--如何使用flyway">4. 如何使用Flyway</h1> <p>使用Flyway ，我们需要准备Flyway 将要执行的数据库脚本（Flyway 支持sql 脚本与java 代码，这里认为在Flyway 下执行数据库更新操作的java 代码也是一种数据库脚本），然后通过Flyway 提供的几种不同运行方式来执行这些脚本。<strong>（以下配置参数说明基于Flyway 1.7 版本，新的2.0 版本在配置参数上有不少变动，与下面的介绍会有不少出入，以下说明仅供参考）</strong></p> <h2 id="41-数据库脚本">4.1. 数据库脚本</h2> <p>Flyway 的主要任务是管理数据库的版本更新，在Flyway 中称每次数据库更新为一个migration ，为了更顺口，我们下面称之为数据库脚本。Flyway 支持SQL-based migrations 和Java-based migrations 。</p> <p>Flyway 支持的数据库脚本有sql 脚本与java 代码，sql 脚本即普通的sql 脚本，包含创建数据库、表，更新库表结构，数据插入、更新、删除等sql 语句，java 代码则是通过一个有效的数据源，使用java 语言来进行数据库的操作，这里针对的读者是对数据库操作有一定熟悉程度的群体，不再详细讲解如何编写数据库脚本。</p> <h3 id="411-flyway的sql脚本与java代码都遵循以下默认规约">4.1.1. Flyway的sql脚本与java代码都遵循以下默认规约：</h3> <ul> <li>SQL 脚本文件默认位置是项目的源文件夹下的db/migration 目录。</li> <li>Java 代码默认位于db.migration 包。</li> <li>SQL 脚本文件及Java 代码类名必须遵循以下命名规则：V<version>[_<seq>][__description] 。版本号的数字间以小数点（. ）或下划线（_ ）分隔开，版本号与描述间以连续的两个下划线（__ ）分隔开。如V1_1_0__Update.sql 。Java 类名规约不允许存在小数点，所以Java 类名中版本号的数字间只能以下划线进行分隔。</seq></version>
</li> </ul> <h2 id="42-flyway-的几种运行方式">4.2. Flyway 的几种运行方式</h2> <p>本章主要讲解我们常用的三种Flyway 的执行方式，Flyway 除了提供这三种执行方式外，还提供Ant 任务方式的执行方式，有兴趣的同学可以去官方网站获取相关信息，这里不进行描述。</p> <h3 id="421--命令行方式">4.2.1. 命令行方式</h3> <p>通过命令行方式运行Flyway ，需要下载flyway-commandline 版本并解压到本地，然后flyway （Windows 下flyway.cmd ，Linux 下flyway.sh ）命令执行Flyway 相关操作。</p> <p><strong>命令行方式的特点与规约</strong></p> <ul> <li>无需安装JVM ，Maven ，Ant</li> <li>默认读取conf/flyway.properties 中的配置信息，如果在命令行中指定参数，命令行中指定的参数将覆盖配置文件中的配置</li> <li>还可以通过参数-configFlie=myFlyway.properties 来重新指定flyway 配置文件，可以通过-configFileEncoding=GBK 来指定配置文件的编码格式</li> <li>可以将打包好的java 迁移文件放到jars/ 目录下让flyway 可以找到并运行</li> <li>数据库驱动包（jar ）放到jars/ 目录下</li> <li>sql 脚本文件放到sql/ 目录中</li> </ul> <p><strong>命令行方式运行的配置及使用方法</strong></p> <ul> <li>修改conf/flyway.properties 配置文件</li> <li>拷贝数据库jdbc 驱动jar 到jars/ 目录</li> <li>在sql/ 目录下创建配置好的sql 脚本文件目录路径，如flyway 默认的sql 文件路径为db/migration ，我们就需要在sql/ 目录下创建/db/migration 目录结构</li> <li>将数据库维护脚本放到创建好的sql 脚本文件目录中（维护脚本文件名需要遵循命名规范）</li> <li>在命令行执行命令（从flyway 安装目录开始执行）flyway init （初始化Flyway metadata ）、flyway migrate （执行Flyway 升级操作）、flyway validate （校验Flyway 数据正确性）</li> </ul> <h3 id="422--maven-插件">4.2.2. Maven 插件</h3> <p>配置Maven 插件</p> <div class="language-xml highlighter-rouge"><pre class="highlight"><code>    <span class="nt">&lt;plugin&gt;</span>
           <span class="nt">&lt;groupId&gt;</span>com.googlecode.flyway<span class="nt">&lt;/groupId&gt;</span>
           <span class="nt">&lt;artifactId&gt;</span>flyway-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
           <span class="nt">&lt;version&gt;</span>1.7<span class="nt">&lt;/version&gt;</span>
           <span class="nt">&lt;dependencies&gt;</span>
                  <span class="nt">&lt;dependency&gt;</span>
                         <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
                         <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
                         <span class="nt">&lt;version&gt;</span>${mysql.connector.version}<span class="nt">&lt;/version&gt;</span>
                  <span class="nt">&lt;/dependency&gt;</span>
           <span class="nt">&lt;/dependencies&gt;</span>
           <span class="nt">&lt;configuration&gt;</span>
                  <span class="nt">&lt;driver&gt;</span>com.mysql.jdbc.Driver<span class="nt">&lt;/driver&gt;</span>
                  <span class="nt">&lt;url&gt;</span>jdbc:mysql://localhost/flywaydemo?useUnicode=true<span class="ni">&amp;amp;</span>characterEncoding=utf-8<span class="nt">&lt;/url&gt;</span>
                  <span class="nt">&lt;user&gt;</span>root<span class="nt">&lt;/user&gt;</span>
                  <span class="nt">&lt;password&gt;&lt;/password&gt;</span>

                  <span class="c">&lt;!-- 设置接受flyway进行版本管理的数据库，多个数据库以逗号分隔 --&gt;</span>
                  <span class="nt">&lt;schemas&gt;</span>flywaydemo<span class="nt">&lt;/schemas&gt;</span>
                  <span class="c">&lt;!-- 设置存放flyway metadata数据的表名 --&gt;</span>
                  <span class="nt">&lt;table&gt;</span>schema_version<span class="nt">&lt;/table&gt;</span>
                  <span class="c">&lt;!-- 设置flyway扫描sql升级脚本、java升级脚本的目录路径或包路径 --&gt;</span>
                  <span class="nt">&lt;locations&gt;</span>
                         <span class="nt">&lt;location&gt;</span>flyway/migrations<span class="nt">&lt;/location&gt;</span>
                         <span class="nt">&lt;location&gt;</span>com.kedacom.flywaydemo.migrations<span class="nt">&lt;/location&gt;</span>
                  <span class="nt">&lt;/locations&gt;</span>
                  <span class="c">&lt;!-- 设置sql脚本文件的编码 --&gt;</span>
                  <span class="nt">&lt;encoding&gt;</span>UTF-8<span class="nt">&lt;/encoding&gt;</span>
                  <span class="c">&lt;!-- 设置执行migrate操作之前的validation行为 --&gt;</span>
                  <span class="nt">&lt;validationMode&gt;</span>ALL<span class="nt">&lt;/validationMode&gt;</span>
                  <span class="c">&lt;!-- 设置当validation失败时的系统行为 --&gt;</span>
                  <span class="nt">&lt;validationErrorMode&gt;</span>FAIL<span class="nt">&lt;/validationErrorMode&gt;</span>
           <span class="nt">&lt;/configuration&gt;</span>
    <span class="nt">&lt;/plugin&gt;</span>
</code></pre></div> <p><strong>上面的插件配置包含了几方面的配置信息：</strong></p> <ul> <li>声明插件</li> <li>声明数据库驱动的依赖包</li> <li>Flyway 配置——数据库连接配置</li> <li>Flyway 配置——Flyway 参数与行为配置</li> </ul> <p><strong>执行Maven 命令进行Flyway 操作（下面列出几种常用的操作）</strong></p> <ul> <li>mvn flyway:init （初始化Flyway metadata ）</li> <li>mvn flyway:migrate （执行Flyway 升级操作）</li> <li>mvn flyway:validate （校验Flyway 数据正确性）</li> </ul> <h3 id="423--在应用启动时自动运行结合spring-">4.2.3. 在应用启动时自动运行（结合Spring ）</h3> <p>定义在应用启动时自动运行Flyway 的Java 类，并实现其逻辑代码</p> <div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">FlywayMigration</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="n">DataSource</span> <span class="n">dataSource</span><span class="o">;</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDataSource</span><span class="o">(</span><span class="n">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">dataSource</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">migrate</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">Flyway</span> <span class="n">flyway</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Flyway</span><span class="o">();</span>
            <span class="n">flyway</span><span class="o">.</span><span class="na">setDataSource</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>

            <span class="n">flyway</span><span class="o">.</span><span class="na">setSchemas</span><span class="o">(</span><span class="s">"flywaydemo"</span><span class="o">);</span> <span class="c1">// 设置接受flyway进行版本管理的多个数据库</span>
            <span class="n">flyway</span><span class="o">.</span><span class="na">setTable</span><span class="o">(</span><span class="s">"schema_version"</span><span class="o">);</span> <span class="c1">// 设置存放flyway metadata数据的表名</span>
            <span class="n">flyway</span><span class="o">.</span><span class="na">setLocations</span><span class="o">(</span><span class="s">"flyway/migrations"</span><span class="o">,</span> <span class="s">"com.kedacom.flywaydemo.migrations"</span><span class="o">);</span> <span class="c1">// 设置flyway扫描sql升级脚本、java升级脚本的目录路径或包路径</span>
            <span class="n">flyway</span><span class="o">.</span><span class="na">setEncoding</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">);</span> <span class="c1">// 设置sql脚本文件的编码</span>
            <span class="n">flyway</span><span class="o">.</span><span class="na">setValidationMode</span><span class="o">(</span><span class="n">ValidationMode</span><span class="o">.</span><span class="na">ALL</span><span class="o">);</span> <span class="c1">// 设置执行migrate操作之前的validation行为</span>
            <span class="n">flyway</span><span class="o">.</span><span class="na">setValidationErrorMode</span><span class="o">(</span><span class="n">ValidationErrorMode</span><span class="o">.</span><span class="na">FAIL</span><span class="o">);</span> <span class="c1">// 设置当validation失败时的系统行为</span>

            <span class="n">flyway</span><span class="o">.</span><span class="na">migrate</span><span class="o">();</span>
        <span class="o">}</span>

    <span class="o">}</span>
</code></pre></div> <p>在Spring 中根据上面实现的类来定义（实例化）一个bean</p> <div class="language-xml highlighter-rouge"><pre class="highlight"><code>    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"flywayMigration"</span> <span class="na">class=</span><span class="s">"com.kedacom.flywaydemo.FlywayMigration"</span> <span class="na">init-method=</span><span class="s">"migrate"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
</code></pre></div> <p>从上面的bean定义中我们可以看到，我们为flywayMigration 这个bean实例注入了一个数据源，Flyway 的所有操作将针对这个数据源进行；同时我们通过init-method 属性指定了Spring 在实例化该bean 以后，主动执行该bean 的migrate 方法，而该方法内会执行Flyway 更新数据库的操作。</p> <p>至此，我们达到了在应用启动时，Spring 实例化上下文的时候，在Spring 实例化flywayMigration 这个bean 的时候，自动执行Flyway 更新数据库的操作。</p> <p>但是，我们还没有达到目的，万一Flyway 还在更新数据库，没有完成更新操作之前，应用程序的其他逻辑已经开始使用数据库进行其他操作了，会导致应用程序产生很多bug ，甚至根本运行不起来。</p> <p>要解决这个问题，我们可以利用Spring 的bean 依赖原理，让关键的数据库操作bean 依赖于flywayMigration 这个bean ，达到在flywayMigration 没有实例化完成（数据库更新操作完成）之前，不能进行任何其他数据库相关操作。</p> <p>利用Spring 的bean 依赖让flywayMigration 优先处理数据库更新操作</p> <div class="language-xml highlighter-rouge"><pre class="highlight"><code>    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"jdbcTemplate"</span> <span class="na">class=</span><span class="s">"org.springframework.jdbc.core.JdbcTemplate"</span> <span class="na">depends-on=</span><span class="s">"flywayMigration"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"txManager"</span> <span class="na">class=</span><span class="s">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span> <span class="na">depends-on=</span><span class="s">"flywayMigration"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
</code></pre></div> <h1 id="5--总结">5. 总结</h1> <p>本篇我们介绍了什么是Flyway，为什么使用Flyway，以及如何使用Flyway ，但实际产品/项目中的情况可能更复杂，仅靠对Flyway技术使用上的了解并不能达到我们满意的解决方案，为此我将在下一篇中介绍我们结合项目实际的问题形成的一些基于Flyway 的数据库版本管理解决方案。</p> <div class="entry-meta"> <br> <hr> <span class="entry-tags"><a href="https://meijw.github.io/Blog//tags/#Microservices" title="Pages tagged Microservices" class="tag"><span class="term">Microservices</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=https://meijw.github.io/Blog//2017/06/08/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7Flyway-%E6%A6%82%E5%BF%B5%E7%AF%87/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Share</span> </a> <a href="https://twitter.com/intent/tweet?text=https://meijw.github.io/Blog//2017/06/08/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7Flyway-%E6%A6%82%E5%BF%B5%E7%AF%87/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=https://meijw.github.io/Blog//2017/06/08/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7Flyway-%E6%A6%82%E5%BF%B5%E7%AF%87/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> </div> </div> </header> <!-- JS --> <script src="https://meijw.github.io/Blog//assets/js/jquery-1.12.0.min.js"></script> <script src="https://meijw.github.io/Blog//assets/js/jquery.dlmenu.min.js"></script> <script src="https://meijw.github.io/Blog//assets/js/jquery.goup.min.js"></script> <script src="https://meijw.github.io/Blog//assets/js/jquery.magnific-popup.min.js"></script> <script src="https://meijw.github.io/Blog//assets/js/jquery.fitvid.min.js"></script> <script src="https://meijw.github.io/Blog//assets/js/scripts.js"></script> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>
